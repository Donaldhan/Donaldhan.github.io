---
layout: page
title: ä»¥å¤ªåŠçš„é»‘ä¸è¢œUniswapV3
subtitle: ä»¥å¤ªåŠçš„é»‘ä¸è¢œUniswapV3
date: 2022-10-10 23:37:00
author: Ravitn
catalog: true
category: solidity
categories:
    - solidity
tags:
    - Uniswap
---


# å¼•è¨€
Uniswapåè®®æ˜¯ä¸€ä¸ªç”¨æ¥åœ¨ä»¥å¤ªåŠåŒºå—é“¾ä¸Šäº¤æ˜“åŠ å¯†è´§å¸ï¼ˆERC-20ä»£å¸ï¼‰çš„ç‚¹å¯¹åˆçº¦ç³»ç»Ÿã€‚è¿™ä¸ªåè®®é€šè¿‡ä¸€ä¸ªæŒä¹…åŒ–ã€ä¸å¯æ›´æ”¹çš„æ™ºèƒ½åˆçº¦é›†åˆæ¥å®ç°ï¼Œæ—¨åœ¨ä¼˜å…ˆè€ƒè™‘æŠ—å®¡æŸ¥æ€§ã€å®‰å…¨æ€§ã€è‡ªæˆ‘ç›‘ç®¡ï¼Œ
ä»¥åŠåœ¨æ²¡æœ‰ä»»ä½•å¯èƒ½æœ‰é€‰æ‹©åœ°é™åˆ¶è®¿é—®çš„å¯ä¿¡ä¸­ä»‹çš„æƒ…å†µä¸‹è¿è¡Œã€‚ç®€å•ç‚¹è¯´å°±æ˜¯é€šè¿‡æ™ºèƒ½åˆçº¦å®ç°äº†ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„ERC-20ä»£å¸çš„è‡ªåŠ¨äº¤æ˜“ç³»ç»Ÿã€‚V2ç‰ˆæœ¬åŸºäºæ’å®šä¹˜ç§¯å…¬å¼çš„è‡ªåŠ¨åšå¸‚å•†ï¼ˆAMMï¼‰äº¤æ˜“æœºåˆ¶ï¼Œ
ç”±äºv2æ‰€æœ‰çš„äº¤æ˜“pairå…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªäº¤æ˜“æ± ä¸­è¿›è¡Œç®¡ç†ï¼Œä¸ä¾¿äºç²¾ç»†åŒ–çš„æµåŠ¨æ€§ç®¡ç†ï¼ŒåŒæ—¶åŸºäºæ’å®šä¹˜ç§¯å…¬å¼çš„è‡ªåŠ¨åšå¸‚å•†ï¼ˆAMMï¼‰äº¤æ˜“æœºåˆ¶å­˜åœ¨èµ„é‡‘åˆ©ç”¨æ•ˆç‡ä½çš„é—®é¢˜ï¼Œuniswapå›¢é˜Ÿï¼Œ2020å¹´5æœˆæ¨å‡º
v2ä¹‹åçš„ä¸€å¹´åï¼Œæ¨å‡ºçš„v3ï¼Œæä¾›é›†ä¸­æµåŠ¨æ€§æœºåˆ¶ï¼Œæä¾›èµ„é‡‘çš„åˆ©ç”¨æ•ˆç‡ï¼ŒåŒæ—¶å¢å¼ºçš„oralceï¼Œç”¨æˆ·ä¸ç”¨æ ¹æ®å†å²åŒºå—çš„ä»·æ ¼ä¿¡æ¯è®¡ç®—ä»·æ ¼ï¼Œä½¿ç”¨åˆçº¦çš„oracleåŠŸèƒ½ï¼Œå°±å¯ä»¥è·å–åŸºäºTWAPçš„ä»·æ ¼ï¼Œä»Šå¤©
æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹v3æ–°ç‰¹æ€§åŠç›¸åº”åˆçº¦åŠŸèƒ½æ¶æ„ã€‚


# ç›®å½•
* [æ–°ç‰¹æ€§](#æ–°ç‰¹æ€§) 
* [æ¶æ„å˜æ›´](#æ¶æ„å˜æ›´) 
    * [ORACLE UPGRADES](#oracle-upgrades) 
* [uniswapä½“éªŒ](#uniswapä½“éªŒ) 
* [é›†ä¸­æµåŠ¨æ€§å®ç°](#é›†ä¸­æµåŠ¨æ€§å®ç°) 
* [v3åˆçº¦æ¶æ„](#v3åˆçº¦æ¶æ„) 
    * [v3-core](#v3-core) 
    * [v3-periphery](#v3-periphery) 
* [æ€»ç»“](#æ€»ç»“)     
* [é™„](#é™„) 


# æ–°ç‰¹æ€§
* é›†ä¸­æµåŠ¨æ€§ï¼šé›†ä¸­æµåŠ¨æ€§æé«˜èµ„é‡‘çš„åˆ©ç”¨æ•ˆç‡ï¼Œæé«˜æµç¨‹ï¼Œé¿å…ç±»ä¼¼V2èµ„é‡‘æ± ä¸­çš„äº¤æ˜“å¯¹ï¼Œå‡ºç°æç«¯çš„æƒ…å†µï¼Œå¯¼è‡´æ± æµåŠ¨æ€§è§åº•ï¼›
æŒ‡å®šæŠ¥ä»·åŒºé—´ï¼ŒåŠåŒºé—´æ­¥é•¿ï¼›æµåŠ¨æ€§æä¾›è€…å¯ä»¥æä¾›ä¸€ä¸ªæ­¦æ–­çš„ä»·æ ¼åŒºé—´ï¼›
* çµæ´»çš„è´¹ç”¨ï¼š0.05%, 0.30%, and 1%. æµåŠ¨æ± åˆ›å»ºè€…ï¼Œå¯ä»¥æŒ‡å®šè´¹ç”¨ï¼ŒåŒæ—¶UNI governanceå¯ä»¥æ·»åŠ å…¶ä»–çš„è´¹ç”¨åˆ°è´¹ç”¨é›†ï¼›
* Improved Price Oracleï¼šæä¾›ç”¨æˆ·æŸ¥è¯¢æœ€è¿‘ä»·æ ¼ï¼Œä¸ä¾èµ–ä¸TWAPï¼ˆ time-weighted average price (TWAP)ï¼‰çš„checkpointå€¼ï¼›
* Liquidity Oracle:æä¾›åŸºäºæ—¶é—´çš„å¹³å‡æµåŠ¨æ€§é¢„è¨€æœºåˆçº¦ï¼›


# æ¶æ„å˜æ›´
* å¤šæµåŠ¨æ± æ¨¡å¼ï¼Œæ¯ä¸ªäº¤æ˜“å¯¹å¯ä»¥ä¸€ä¸ªæ± ï¼Œä¹Ÿå¯ä»¥å¤šä¸ªäº¤æ˜“å¯¹å¤šä¸ªæ± ï¼›V2æ‰€æœ‰çš„äº¤æ˜“å¯¹éƒ½åœ¨ä¸€ä¸ªæ± ï¼›
* äº¤æ˜“tokenä¸åœ¨å•å•æ”¯æŒERC20ï¼Œ æ‹“å±•è‡³éåŒè´¨åŒ–tokenï¼› åœ¨Uniswap peripheryåˆ›å»ºäº¤æ˜“æ± ï¼Œå¯ä»¥å¯¹ERC20è¿›è¡ŒåŒ…è£…ï¼›
* governanceï¼šæ¯ä¸ªæ± æœ‰ä¸€ä¸ªownerï¼Œå¯ä»¥æ”¯æŒtick spaceï¼ŒåŒæ—¶å¯ä»¥è®¾ç½®æ²¡æœ‰ä¸ªtickçš„feeï¼Œä¸€æ—¦è®¾ç½®ä¸å¯æ”¹å˜ï¼›
* price oracleå‡çº§ï¼›

## ORACLE UPGRADES
v2ç”¨æˆ·å¦‚æœéœ€è¦è®¡ç®—æŸä¸ªperiodçš„TWAPï¼Œéœ€è¦è¿½è¸ªä»periodå¼€å§‹åˆ°ç»“æŸçš„checkpointï¼ŒV3ä¸­ä¸åœ¨éœ€è¦è¿½è¸ªæ£€æŸ¥ç‚¹ï¼Œ
å¯ä»¥è·å–æœ€è¿‘periodçš„TWAPï¼ŒV3ä¼šlogè¿™äº›priceçš„checkpointï¼Œå…è®¸ç”¨æˆ·è®¡ç®—TWAPç®—æœ¯å¹³å‡å€¼ï¼›

Oracle Observationsï¼šåœ¨v2åªä¼šä¿å­˜æœ€è¿‘åŒºå—çš„ä»·æ ¼æ£€æŸ¥ç‚¹ï¼Œç”¨æˆ·éœ€è¦æœºåˆ¶æ‹‰å–ä»¥å‰åŒºå—çš„ä»·æ ¼ç‚¹è¿›è¡Œç»Ÿè®¡ã€‚v3ä¸­ï¼Œæ‰€æœ‰çš„ä»·æ ¼ç‚¹å°†ä¼šä¿å­˜ä¸€ä¸ªç¯å½¢ä»·æ ¼æ£€æŸ¥ç‚¹ä¸­ï¼Œ
ï¼Œç¯å½¢ä¸­æœ€å¤§å¯ä»¥å®¹çº³65,536 checkpointsï¼Œå½“æ–°çš„æ£€æŸ¥ç‚¹äº§ç”Ÿæ—¶ï¼Œç¯å½¢ä¸­çš„æ£€æŸ¥ç‚¹æ²¡æœ‰slotï¼Œåˆ™è€çš„slotçš„å°†ä¼šè¢«è¦†ç›–ï¼›

Geometric Mean Price Oracleï¼šV2ä¸­ï¼Œäº¤æ˜“å¯¹çš„tokenæ˜¯å•ç‹¬è·Ÿè¸ªçš„ï¼Œæ²¡æœ‰å…³è”æ€§ï¼ŒV3å°†ä¼šæ ¹æ®äº¤æ˜“å¯¹çš„åœ¨tickä¸­éšæ—¶é—´çš„token price ratioï¼Œè®¡ç®—ç›¸åº”çš„TWAPï¼›

Liquidity Oraceï¼šv3åŒæ—¶æ¯ä¸ªåŒºå—åŸºäºç§’çº§çš„seconds-weighted accumulator, ç”¨äºåˆ†é…æµåŠ¨æ€§å¥–åŠ±ï¼›


# uniswapä½“éªŒ
äº¤æ˜“æ± ï¼Œæˆ‘ä»¬ä»¥ETHå’ŒUSDTä¸ºä¾‹ï¼Œè¿›å…¥äº¤æ˜“æ± ç•Œé¢
![uniswap3-pool](/image/uniswapv3/uniswap3-pool.png)

ç‚¹å‡»æ·»åŠ æµåŠ¨æ€§ï¼Œå°†ä¼šè·³åˆ°æ·»åŠ æµåŠ¨æ€§é¡µé¢ï¼Œç‚¹å‡»äº¤æ˜“è¿›å…¥swapæ“ä½œç•Œé¢

* æ·»åŠ æµåŠ¨æ€§
![uniswap3-pool-liquidty-add](/image/uniswapv3/uniswap3-pool-liquidty-add.png)
é€‰æ‹©äº¤æ˜“æ± å…³è”tokenï¼Œ æˆ‘ä»¬é€‰æ‹©ä¸ºethå’Œswapï¼Œå¹¶é€‰æ‹©æµåŠ¨æ€§ä»·æ ¼åŒºé—´ï¼ˆå…‘æ¢ç‡ï¼‰


* äº¤æ˜“æ“ä½œï¼ˆswapï¼‰
![uniswapv3-swap](/image/uniswapv3/uniswapv3-swap.png)
è¾“å…¥ç»™å®šçš„eth,æ ¹æ®å½“å‰äº¤æ˜“æ± ä»·æ ¼swapå‡ºç›¸åº”çš„USDTã€‚å…‘æ¢æ—¶ï¼Œå‰ç«¯å°†ä¼šæ‹‰å–å½“å‰äº¤æ˜“æ± çš„æœ€ä¼˜äº¤æ˜“ä»·æ ¼ï¼ˆoracleçš„TWAPï¼‰ï¼Œè¿›è¡Œswapæ“ä½œã€‚


* äº¤æ˜“åˆ—è¡¨
![uniswap3-pool-swap-transactions](/image/uniswapv3/uniswap3-pool-swap-transactions.png)


# é›†ä¸­æµåŠ¨æ€§å®ç°

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹v2çš„AMM DEXæ›²çº¿ï¼Œä¸ºä¸‹å›¾ä¸­çš„ç»¿è‰²éƒ¨åˆ†ã€‚
![uniswap3-real-reservers](/image/uniswapv3/uniswap3-real-reservers.png)

åœ¨uniswap v2ï¼ŒæµåŠ¨æ€§ä»·æ ¼å¯ä»¥æ— é™å¤§ï¼Œå½“ä»·æ ¼è¶‹å‘äºæ›²çº¿ä¸¤ç«¯çš„æ— ç©·å¤§æ˜¯ï¼ŒæµåŠ¨æ€§å°†ä¼šå‡å°‘ï¼Œæ²¡æœ‰äººæ„¿æ„ä½¿ç”¨è¶…è¿‡çš„ä»·æ ¼ï¼Œswapå‡ºtokenï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ª
äº¤æ˜“æ± çš„èµ„é‡‘åˆ©ç”¨ç‡ä¸é«˜ï¼Œä¸ºäº†æ”¹å–„è¿™ç§æƒ…å†µï¼Œv3ï¼Œå°†å…è®¸ç”¨æˆ·æ·»åŠ ç»™å®šä»·æ ¼åŒºé—´çš„æµåŠ¨æ€§ï¼Œå¦‚ä¸Šå›¾ä¸­çš„é»„çº¿éƒ¨åˆ†ã€‚è¿™æ ·æ•´ä¸ªäº¤æ˜“æ± çš„æµåŠ¨æµåŠ¨æ€§åˆ†å¸ƒå°†ä¼š
å¦‚å›¾ï¼š

![uniswap3-liquidity-distributions](/image/uniswapv3/uniswap3-liquidity-distributions.png)

æä¾›ä¸åŒæ·±åº¦çš„æµåŠ¨æ€§ï¼Œæä¾›èµ„é‡‘çš„åˆ©ç”¨æ•ˆç‡ï¼›ç”¨æˆ·è‡ªå·±å¯ä»¥ä»»æ„ä»·æ ¼åŒºé—´çš„æµåŠ¨æ€§ï¼Œå°†ä¼šå­˜åœ¨ç²¾åº¦é—®é¢˜ï¼š

> ä»·æ ¼ç²¾åº¦é—®é¢˜
å› ä¸ºç”¨æˆ·å¯ä»¥åœ¨ä»»æ„ [P0,P1] ä»·æ ¼åŒºé—´å†…æä¾›æµåŠ¨æ€§ï¼ŒUniswap v3 éœ€è¦ä¿å­˜æ¯ä¸€ä¸ªç”¨æˆ·æä¾›æµåŠ¨æ€§çš„è¾¹ç•Œä»·æ ¼ï¼Œå³ P0 å’Œ P1ã€‚è¿™æ ·å°±å¼•å…¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå‡è®¾ä¸¤ä¸ªç”¨æˆ·æä¾›çš„æµåŠ¨æ€§ä»·æ ¼ä¸‹é™åˆ†åˆ«æ˜¯ 5.00000001 å’Œ 5.00000002ï¼Œé‚£ä¹ˆ Uniswap éœ€è¦æ ‡è®°ä»·æ ¼ä¸º 5.00000001 å’Œ 5.00000002 çš„å¯¹åº”çš„æµåŠ¨æ€§å¤§å°ã€‚åŒæ—¶å½“äº¤æ˜“å‘ç”Ÿæ—¶ï¼Œéœ€è¦å°† [5.00000001,5.00000002] ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ä»·æ ¼åŒºé—´è¿›è¡Œè®¡ç®—ã€‚è¿™æ ·ä¼šå¯¼è‡´ï¼š

å‡ ä¹å¾ˆéš¾æœ‰ä¸¤ä¸ªæµåŠ¨æ€§è®¾ç½®ç›¸åŒçš„ä»·æ ¼è¾¹ç•Œï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¶ˆè€—å¤§é‡åˆçº¦å­˜å‚¨ç©ºé—´ä¿å­˜è¿™äº›çŠ¶æ€ï¼Œ
å½“è¿›è¡Œäº¤æ˜“è®¡ç®—æ—¶ï¼Œä»·æ ¼å˜åŒ–è¢«åˆ‡åˆ†æˆå¾ˆå¤šä¸ªå°çš„èŒƒå›´åŒºé—´ï¼Œéœ€è¦é€ä¸€åˆ†æ®µè¿›è¡Œè®¡ç®—ï¼Œè¿™ä¼šæ¶ˆè€—å¤§é‡çš„ gasï¼Œå¹¶ä¸”å¦‚æœèŒƒå›´çš„ä»·å·®å¤ªå°ï¼Œå¯èƒ½ä¼šå¼•å‘è®¡ç®—ç²¾åº¦çš„é—®é¢˜ï¼Œ
Uniswap v3 è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯ï¼Œå°† [Pmin,Pmax] è¿™ä¸€æ®µè¿ç»­çš„ä»·æ ¼èŒƒå›´ä¸ºï¼Œåˆ†å‰²æˆæœ‰é™ä¸ªç¦»æ•£çš„ä»·æ ¼ç‚¹ã€‚æ¯ä¸€ä¸ªä»·æ ¼å¯¹åº”ä¸€ä¸ª tickï¼Œç”¨æˆ·åœ¨è®¾ç½®æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´æ—¶ï¼Œåªèƒ½é€‰æ‹©è¿™äº›ç¦»æ•£çš„ä»·æ ¼ç‚¹ä¸­çš„æŸä¸€ä¸ªä½œä¸ºæµåŠ¨æ€§çš„è¾¹ç•Œä»·æ ¼ã€‚

Uniswap v3 é‡‡ç”¨äº†ç­‰æ¯”æ•°åˆ—çš„å½¢å¼ç¡®å®šä»·æ ¼æ•°åˆ—ï¼Œå…¬æ¯”ä¸º 1.0001ã€‚å³ä¸‹ä¸€ä¸ªä»·æ ¼ç‚¹ä¸ºå½“å‰ä»·æ ¼ç‚¹çš„ 100.01%;å¦‚æ­¤ä¸€æ¥ Uniswap v3 å¯ä»¥æä¾›æ¯”è¾ƒç»†ç²’åº¦çš„ä»·æ ¼é€‰æ‹©èŒƒå›´ï¼ˆæ¯ä¸ªå¯é€‰ä»·æ ¼ä¹‹é—´çš„å·®å€¼ä¸º 0.01%ï¼‰ï¼ŒåŒæ—¶åˆå¯ä»¥å°†è®¡ç®—çš„å¤æ‚åº¦æ§åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ã€‚


> v3æ ¸å¿ƒæ€è·¯

1. å°†æµåŠ¨æ± çš„tickåŒ–ï¼Œæ¯ä¸ªtickç²’åº¦ï¼Œé»˜è®¤ä¸º0.01ï¼›poolå°†ä¼šè¿½è¸ªæ²¡æœ‰tickçš„æ¯ç§’çš„sqrtä»·æ ¼ï¼›åœ¨åˆå§‹åŒ–æ—¶ï¼Œtickæ²¡æœ‰æš‚ç”¨çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆå§‹åŒ–ï¼›
2. poolåˆå§‹åŒ–æ—¶ï¼Œä¼šè®¾ç½®tickSpacingï¼Œåªæœ‰tickSpacingå…è®¸çš„èŒƒå›´å†…ï¼Œæ‰èƒ½æ·»åŠ åˆ°poolä¸­ï¼Œæ¯”å¦‚å¦‚æœtickSpacingè®¾ä¸º2,åˆ™(...-4, -2, 0, 2, 4...)å½¢å¼çš„tickæ‰å¯ä»¥åˆå§‹åŒ–ï¼Œç”¨æˆ·æ·»åŠ æµåŠ¨æ€§ï¼Œ
åªèƒ½æ·»åŠ tickè§„åˆ™å…è®¸çš„ä»·æ ¼åŒºé—´ï¼›
3. ä¸ºäº†ç¡®ä¿æ­£ç¡®æ•°é‡çš„æµåŠ¨æ€§çš„åŠ å…¥å’Œé€€å‡ºï¼Œpoolåˆçº¦å°†ä¼šè¿½è¸ªpoolçš„å…¨å±€çŠ¶æ€ï¼Œæ¯ä¸ªtickåŠæ¯ä¸ªä½ç½®çš„çŠ¶æ€ï¼›

##  Global State


| Type | Variable Name | Notation |  
|  ----  | ----  |   
|  uint128 |  liquidity | ğ¿|   
|  uint160 |  sqrtPriceX96|  sqrt(ğ‘ƒ) |   
|  int24 | tick |  ğ‘–ğ‘ |  
|  uint256 |  feeGrowthGlobal0X128|  ğ‘“ğ‘”,0 |   
|  uint256 | feeGrowthGlobal1X128 |  ğ‘“ğ‘”,1 |   
|  uint128 | protocolFees.token0  | ğ‘“ğ‘,0 |  
|  uint128 | protocolFees.token1 |  ğ‘“ğ‘,1 |   

```
pair(token xï¼Œ token y) :

L=sqrt(xy);     
sqrt(p)=sqrt(y/x);    


x=L/sqrt(p);    
y=L/sqrt(p);    


tick(ic)= log(sqrt[basePrice]^sqrt[p]);
 ```

æˆ‘ä»¬ä½¿ç”¨Lå’Œsqrt(p)è·Ÿè¸ªæµåŠ¨æ€§ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨æ¯ä¸ªtickï¼Œä»»ä½•æ—¶é—´swapçš„äº§ç”Ÿï¼Œå°†ä¼šå¯¼è‡´sqrt(p)çš„å˜åŠ¨ï¼›

[ğ‘“ğ‘”,0/ğ‘“ğ‘”,1]ä¸ºswapçš„å…¨å±€token0, token1è´¹ç”¨, æ”¶è´¹æ—¶ï¼Œä»¥(0.0001%)ä¸ºåŸºç‚¹è¿›è¡Œæ”¶è´¹ï¼›


[ğ‘“ğ‘,0/ğ‘“ğ‘,1]ä¸ºåè®®token0, token1è´¹ç”¨ï¼Œå…·ä½“åˆ°äº¤æ˜“æ± ï¼›




## Tick-Indexed State

| Type | Variable Name | Notation |  
|  ----  | ----  |   
| int128 | liquidityNet |  Î”ğ¿ |   
| uint128 | liquidityGross | ğ¿ğ‘” |  
| uint256 | feeGrowthOutside0X128 | ğ‘“ğ‘œ,0 |  
| uint256 | feeGrowthOutside1X128 | ğ‘“ğ‘œ,1 |  
| uint256 | secondsOutside | ğ‘ ğ‘œ |  
| uint256 | tickCumulativeOutside | ğ‘–ğ‘œ |  
| uint256 | secondsPerLiquidityOutsideX128 | ğ‘ ğ‘™o |  

liquidityNet(Î”ğ¿):æ¯ä¸ªtickå†…çš„æµåŠ¨æ€§ï¼›
liquidityGross(ğ¿ğ‘”):ç”¨äºåˆ¤æ–­å½“æµåŠ¨æ€§ä¸åœ¨ç»™å®šçš„èŒƒå›´å†…æ—¶ï¼Œæ˜¯å¦éœ€è¦æ›´æ–°ticks bitMap;
 [ğ‘“ğ‘œ,0/ğ‘“ğ‘œ,1]ï¼šç”¨äºè¿½è¸ªtoken0, token1åœ¨ç»™ä½ å®šèŒƒå›´å¤–çš„feeï¼›
secondsOutside, tickCumulativeOutside,secondsPerLiquidityOutsideX128ï¼šç”¨äºè®¡ç®—åˆçº¦å¤–éƒ¨çš„æ›´ç»†ç²’åº¦çš„æ”¶ç›Šï¼›


##  Position-Indexed State

| Type | Variable Name | Notation |  
|  ----  | ----  |     
| uint128  | liquidity | ğ‘™ |   
| uint256  | feeGrowthInside0LastX128 | ğ‘“ğ‘Ÿ,0 (ğ‘¡0) |   
| uint256  | feeGrowthInside1LastX128  | ğ‘“ğ‘Ÿ,1 (ğ‘¡0) |   

liquidity (ğ‘™): ç”¨äºè¡¨ç¤ºä¸Šæ¬¡ä½ç½®ç‚¹çš„è™šæ‹ŸæµåŠ¨æ€§ï¼›
 [ğ‘“ğ‘Ÿ,0 (ğ‘¡0) / ğ‘“ğ‘Ÿ,1 (ğ‘¡0)]ï¼šç”¨äºè®¡ç®—token0, token1çš„uncollected feesï¼›



è§£å†³é›†ä¸­æµåŠ¨æ€§ï¼Œæ¶‰åŠæ¯ä¸ªtickå†…çš„äº¤æ˜“feeï¼Œå·²ç»è·¨tickçš„äº¤æ˜“è´¹ç”¨ï¼Œæ¯”å¦‚å¯èƒ½å¤§äºtickçš„ä¸Šé™ï¼Œä¹Ÿå¯èƒ½å°äºtickçš„ä¸‹é™ï¼Œæˆ–è€…ä¸åœ¨æ•´ä¸ªtickçš„bit mapèŒƒå›´ä¹‹å†…ï¼Œéœ€è¦è®¡ç®—ç›¸åº”çš„è´¹ç”¨ï¼›
é’ˆå¯¹è™šæ‹ŸæµåŠ¨æ€§ï¼Œæœ‰äº›æµåŠ¨æ€§ä¸èƒ½åæ˜ ä»åˆçº¦åˆ›å»ºæ—¶çš„feeï¼Œæˆ‘ä»¬ç§°ä¸ºuncollected feesï¼Œ
æˆ‘ä»¬é€šè¿‡Position-Indexed Stateå¯ä»¥è®¡ç®—ç›¸åº”çš„uncollected feesã€‚



# v3åˆçº¦æ¶æ„

![uniswap-v3-contract-framework](/image/uniswapv3/uniswap-v3-contract-framework.png)

v3åˆçº¦ä½œæœ€é‡è¦çš„ä¸¤ä¸ªæ¨¡å—äº¤æ˜“æ± æ ¸å¿ƒv3-coreå’Œå¤–å›´çš„swapè·¯ç”±æ¨¡å—v3-periphery

## v3-core
æä¾›äº¤æ˜“æ± çš„åˆ›å»ºï¼Œäº¤æ˜“ç›¸å…³çš„æ ¸å¿ƒæ“ä½œï¼Œæ¯”å¦‚æ·»åŠ æµåŠ¨mintï¼Œswapæ“ä½œç­‰ï¼Œç®¡ç†ä»·æ ¼tick mapï¼Œç”¨æˆ·çš„ä½ç½®ä¿¡æ¯ï¼Œäº¤æ˜“æ± çŠ¶æ€ï¼ŒåŠoralceï¼Œ ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåˆçº¦ï¼š

* IUniswapV3PoolImmutablesï¼šäº¤æ˜“æ± å¸¸é‡ï¼Œæ¯”å¦‚ï¼šå·¥å‚åœ°å€ã€äº¤æ˜“pairï¼Œ token0ï¼Œtoken1çš„åœ°å€ï¼ŒåŠtickspacingå’Œæ¯ä¸ªæ± çš„æœ€å¤§æµåŠ¨æ€§ï¼›
* IUniswapV3PoolStateï¼šç”¨æˆ·è®°å½•äº¤æ˜“æ± çš„çŠ¶æ€ï¼Œæ¯”å¦‚tickçš„è´¹ç”¨ä¿¡æ¯ï¼Œä»¥åŠtickçš„oracleè¿½è¸ªä¿¡æ¯ï¼ˆobservationsï¼‰ï¼›
* IUniswapV3PoolActions:ä¸»è¦ç”¨äºåˆå§‹åŒ–äº¤æ˜“æ± ï¼Œæä¾›ä¸äº¤æ˜“æ ¸å¿ƒæ“ä½œï¼Œæ¯”å¦‚mintï¼Œburnï¼Œswapï¼Œflashç­‰æ“ä½œä»¥åŠè®°å½•äº¤æ˜“æ± å¿«ç…§ä¿¡æ¯increaseObservationCardinalityNextï¼›
* IUniswapV3PoolOwnerActionsï¼šæä¾›è®¾ç½®äº¤æ˜“åè®®è´¹ç”¨å’Œæ”¶é›†åè®®è´¹ç”¨
* IUniswapV3Factoryï¼šåˆ›å»ºäº¤æ˜“æ± ï¼ˆäº¤æ˜“æ± token pairï¼ŒåŠtickäº¤æ˜“è´¹ç”¨ï¼‰ï¼›
* UniswapV3Pool:æä¾›mintï¼Œburnï¼Œswapï¼Œflashç­‰æ ¸å¿ƒå®ç°ï¼Œå¦å¤–è¿˜æœ‰oralceçš„è§‚å¯Ÿç‚¹è®°å½•ï¼›

> UniswapV3Poolç»´æŠ¤è€…äº¤æ˜“è€…æ± çš„çŠ¶æ€Slot0, å½“å‰æµåŠ¨æ€§ï¼Œtoken0å’Œtoken1çš„å½“å‰ç´¯è®¡è´¹ç”¨ï¼Œtickä¿¡æ¯ï¼Œtick bitMapä¿¡æ¯ï¼Œç”¨æˆ·æµåŠ¨æ€§ä½ç½®ä¿¡æ¯ï¼ŒåŠoralceè§‚å¯Ÿç‚¹ä¿¡æ¯ï¼›

1. äº¤æ˜“è€…æ± çš„çŠ¶æ€Slot0ï¼šä¸»è¦æœ‰å½“å‰ä»·æ ¼sqrt(x*y)ï¼Œtickï¼Œæœ€è¿‘è§‚å¯Ÿç‚¹ç´¢å¼•ï¼Œå½“å‰å­˜å‚¨è§‚å¯Ÿç‚¹æ•°é‡ï¼Œä¸‹æ¬¡éœ€è¦å­˜å‚¨çš„è§‚å¯Ÿç‚¹ç´¢å¼•ï¼Œåè®®è´¹ç”¨ä»¥åŠäº¤æ˜“æ± æ˜¯å¦é”ä½ï¼›
2. tickä¿¡æ¯: ç»´æŠ¤æ¯ä¸ªtickçš„ä¿¡æ¯ï¼Œä¸»è¦æœ‰å½“å‰tickæµåŠ¨æ€§ï¼ŒæµåŠ¨æ€§ç½‘æ ¼æ•°é‡ï¼ŒtickèŒƒå›´å¤–çš„token0å’Œtoken1çš„feeï¼Œç›¸å¯¹äºå½“å‰tickå¤–çš„æ¯ä¸ªæµåŠ¨æ€§å•å…ƒè¿è¡Œæ—¶é—´secondsï¼Œå½“å‰tickå¤–çš„èŠ±è´¹æ€»æ—¶é—´secondsï¼›
3. tick bitMapä¿¡æ¯ï¼šæ¯ä¸ªtickçš„çŠ¶æ€ç­‰ä¿¡æ¯ï¼›
4. ç”¨æˆ·æµåŠ¨æ€§ä½ç½®ä¿¡æ¯ï¼šç”¨æˆ·åœ¨tickä¸Šçº¿é™ä¹‹é—´çš„æµåŠ¨ï¼Œtoken0å’Œtoken1æ”¶ç›Šï¼Œ åŠæµåŠ¨æ€§fee




## v3-periphery
æä¾›swapç›¸å…³çš„è·¯ç”±æ“ä½œï¼Œå¹¶åœ¨æ²¡æœ‰swapç›¸åº”çš„åŸºäºç”¨æˆ·ä½ç½®ä¿¡æ¯çš„NFTï¼Œå¦‚æœmintæ“ä½œçš„äº¤æ˜“æ± ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºç›¸åº”çš„äº¤æ˜“æ± ï¼›ä¸»è¦æœ‰å‡ ä¸ªåˆçº¦

* NonfungiblePositionManager:éåŒè´¨ä½ç½®ç®¡ç†å™¨ï¼Œæä¾›æµåŠ¨mintï¼Œå¢åŠ ï¼Œå‡å°‘æ“ä½œï¼Œä»¥åŠæ”¶ç›Šè´¹ç”¨çš„æ”¶é›†ï¼›åœ¨mintæµåŠ¨æ€§æ—¶ï¼ŒåŒæ—¶ä¼šåˆ›å»ºåŸºäºä½ç½®çš„NFTï¼›
* NonfungibleTokenPositionDescriptor:æä¾›ç”Ÿæˆä½ç½®NFTæè¿°URLï¼›
* SwapRouter: swapæ“ä½œï¼šæ ¹æ®è¾“å…¥tokenï¼Œswapå‡ºå°½å¯èƒ½å¤§çš„å¦ä¸€ä¸ªtokenï¼›swapè¯„ä¼°æ“ä½œï¼šæ ¹æ®è¾“å…¥çš„tokenæ•°é‡ï¼Œéœ€è¦è¾“å…¥çš„æœ€å°å¦å¤–ä¸€ä¸ªtokençš„æ•°é‡ï¼Œå¹¶æ”¯ä»˜ç›¸åº”çš„è´¹ç”¨åˆ°æ”¶è´¹è´¦æˆ·ï¼›

é’ˆå¯¹ç”¨æˆ·swapçš„tokenInå’ŒtokenOutäº¤æ˜“æ± ä¸å­˜åœ¨æ—¶ï¼Œuniswapå‰ç«¯å°†ä¼šç”Ÿæˆç›¸åº”çš„è·¯å¾„ï¼Œå§”æ‰˜ç»™SwapRouterè¿›è¡Œswapæ“ä½œï¼›
å¤šè·¯å¾„çš„çš„æƒ…å†µç¼–ç ä¸ºï¼štoken0+fee01+token1+fee12+token2+fee23+token3+fee34+token4+..., è¿™ç§æ˜¯é’ˆå¯¹swapæ˜¯å¦‚æœæ²¡æœ‰å¯¹åº”çš„äº¤æ˜“å¯¹pairï¼Œåˆ™ä»ä¸åŒçš„
äº¤æ˜“æ± è¿›è¡Œswapï¼Œ æ¯”å¦‚ä½¿ç”¨token0ï¼Œæƒ³swap token3ï¼Œæ•´ä¸ªswapçš„è·¯å¾„ä¸ºï¼ˆtoken0+fee01+token1ï¼Œtoken1+fee12+token2ï¼Œtoken2+fee23+token3ï¼‰ï¼Œä½¿ç”¨token0ä»
pool01ä¸­swapå‡ºtoken1ï¼Œä½¿ç”¨swapå‡ºçš„token1ä»pool12ä¸­swapå‡ºtoken2ï¼Œ ä½¿ç”¨swapå‡ºçš„token2ä»pool23ä¸­swapå‡ºtoken3ï¼› å…·ä½“è·¯å¾„ç¼–ç å¦‚ä¸‹ï¼š

![uniswap-v3-swap-path-encode](/image/uniswapv3/uniswap-v3-swap-path-encode.png)


* V3Migrator: ä»V2æµåŠ¨æ€§ï¼Œè¿ç§»åˆ°V3ï¼Œå¯ä»¥æŒ‡å®šè¿ç§»æµåŠ¨æ€§ç™¾åˆ†æ¯”ï¼Œæ²¡æœ‰è¿ç§»çš„å°†ä¼šé€€å›ç»™ï¼›

> åˆçº¦å·¥å…·åº“
1. Pathï¼šäº¤æ˜“æ± è·¯å¾„å·¥å…·ï¼Œè·¯å¾„å®é™…ç¼–ç ä¸ºtoken0åœ°å€+fee+token1åœ°å€  ï¼›
2. PoolAddress:äº¤æ˜“æ± åœ°å€å·¥å…·ï¼Œæ ¹æ®äº¤æ˜“æ± keyï¼ŒåŒ…å«token0åœ°å€ï¼Œtoken1åœ°å€ï¼Œfeeï¼Œç”Ÿæˆäº¤æ˜“æ± åœ°å€ï¼›
3. PeripheryPaymentsWithFeeï¼šæä¾›å¸¦ç»­è´¹è´¹ç”¨çš„æ”¯ä»˜ï¼Œæ”¯æŒethå’Œtokenï¼›
4. PeripheryPaymentsï¼šæä¾›æ”¯ä»˜æ“ä½œï¼Œæ”¯æŒethå’Œtokenï¼›
5. Multicallï¼šæ‰¹é‡è°ƒç”¨ä»£ç†åˆçº¦ï¼›


# æ€»ç»“

uniswapV3ä¸»è¦æ˜¯è§£å†³uniswapV2åŸºäºå¸¸é‡çš„AMMæç«¯æƒ…å†µä¸‹çš„æµåŠ¨æ€§ä¸è¶³çš„é—®é¢˜ï¼Œæå‡ºåŸºäºtickçš„é›†ä¸­æµç¨‹æ€§ï¼ŒåŒæ—¶åŠ å…¥çš„äº¤æ˜“æ± çš„æ¦‚å¿µï¼›v2ä¸­æ‰€æœ‰çš„äº¤æ˜“å¯¹åœ¨ä¸€ä¸ªæ± ä¸­ï¼Œv3å¯ä»¥è‡ªå·±ä½¿ç”¨äº¤æ˜“pairï¼Œåˆ›å»ºäº¤æ˜“æ± æ± ï¼Œè‡ªå·±è®¾ç½®äº¤æ˜“è´¹ç”¨ï¼ŒåŠæµåŠ¨æ€§tickåŒºé—´ï¼›å¹¶æ”¹å–„çš„oracleï¼Œç”¨æˆ·ä¸ç”¨è‡ªå·±
è®¡ç®—åŸºäºTWAPï¼ˆ time-weighted average price (TWAP)ï¼‰ï¼Œä½¿ç”¨åˆçº¦è·å–æœ€è¿‘çš„periodçš„TWAPï¼Œå¹¶å…è®¸ç”¨æˆ·è®¡ç®—TWAPç®—æœ¯å¹³å‡å€¼ï¼›


è§£å†³é›†ä¸­æµåŠ¨æ€§ï¼Œæ¶‰åŠæ¯ä¸ªtickå†…çš„äº¤æ˜“feeï¼Œå·²ç»è·¨tickçš„äº¤æ˜“è´¹ç”¨ï¼Œæ¯”å¦‚å¯èƒ½å¤§äºtickçš„ä¸Šé™ï¼Œä¹Ÿå¯èƒ½å°äºtickçš„ä¸‹é™ï¼Œæˆ–è€…ä¸åœ¨æ•´ä¸ªtickçš„bit mapèŒƒå›´ä¹‹å†…ï¼Œéœ€è¦è®¡ç®—ç›¸åº”çš„è´¹ç”¨ã€‚
V3é€šè¿‡ Global Stateå’ŒTick-Indexed Stateæ¥è§£å†³è¿™äº›é—®é¢˜ï¼›

é’ˆå¯¹è™šæ‹ŸæµåŠ¨æ€§ï¼Œæœ‰äº›æµåŠ¨æ€§ä¸èƒ½åæ˜ ä»åˆçº¦åˆ›å»ºæ—¶çš„feeï¼Œæˆ‘ä»¬ç§°ä¸ºuncollected feesï¼Œ
V3é€šè¿‡Position-Indexed Stateå¯ä»¥è®¡ç®—ç›¸åº”çš„uncollected feesã€‚

æä¾›äº¤æ˜“æ± çš„åˆ›å»ºï¼Œäº¤æ˜“ç›¸å…³çš„æ ¸å¿ƒæ“ä½œï¼Œæ¯”å¦‚æ·»åŠ æµåŠ¨mintï¼Œswapæ“ä½œç­‰ï¼Œç®¡ç†ä»·æ ¼tick mapï¼Œç”¨æˆ·çš„ä½ç½®ä¿¡æ¯ï¼Œäº¤æ˜“æ± çŠ¶æ€ï¼ŒåŠoralceï¼›

v3-peripheryæä¾›swapç›¸å…³çš„è·¯ç”±æ“ä½œï¼Œå¹¶åœ¨æ²¡æœ‰swapç›¸åº”çš„åŸºäºç”¨æˆ·ä½ç½®ä¿¡æ¯çš„NFTï¼Œå¦‚æœmintæ“ä½œçš„äº¤æ˜“æ± ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºç›¸åº”çš„äº¤æ˜“æ± ã€‚
UniswapV3Poolç»´æŠ¤è€…äº¤æ˜“è€…æ± çš„çŠ¶æ€Slot0, å½“å‰æµåŠ¨æ€§ï¼Œtoken0å’Œtoken1çš„å½“å‰ç´¯è®¡è´¹ç”¨ï¼Œtickä¿¡æ¯ï¼Œtick bitMapä¿¡æ¯ï¼Œç”¨æˆ·æµåŠ¨æ€§ä½ç½®ä¿¡æ¯ï¼ŒåŠoralceè§‚å¯Ÿç‚¹ä¿¡æ¯ï¼›
1. äº¤æ˜“è€…æ± çš„çŠ¶æ€Slot0ï¼šä¸»è¦æœ‰å½“å‰ä»·æ ¼sqrt(x*y)ï¼Œtickï¼Œæœ€è¿‘è§‚å¯Ÿç‚¹ç´¢å¼•ï¼Œå½“å‰å­˜å‚¨è§‚å¯Ÿç‚¹æ•°é‡ï¼Œä¸‹æ¬¡éœ€è¦å­˜å‚¨çš„è§‚å¯Ÿç‚¹ç´¢å¼•ï¼Œåè®®è´¹ç”¨ä»¥åŠäº¤æ˜“æ± æ˜¯å¦é”ä½ï¼›
2. tickä¿¡æ¯: ç»´æŠ¤æ¯ä¸ªtickçš„ä¿¡æ¯ï¼Œä¸»è¦æœ‰å½“å‰tickæµåŠ¨æ€§ï¼ŒæµåŠ¨æ€§ç½‘æ ¼æ•°é‡ï¼ŒtickèŒƒå›´å¤–çš„token0å’Œtoken1çš„feeï¼Œç›¸å¯¹äºå½“å‰tickå¤–çš„æ¯ä¸ªæµåŠ¨æ€§å•å…ƒè¿è¡Œæ—¶é—´secondsï¼Œå½“å‰tickå¤–çš„èŠ±è´¹æ€»æ—¶é—´secondsï¼›
3. tick bitMapä¿¡æ¯ï¼šæ¯ä¸ªtickçš„çŠ¶æ€ç­‰ä¿¡æ¯ï¼›
4. ç”¨æˆ·æµåŠ¨æ€§ä½ç½®ä¿¡æ¯ï¼šç”¨æˆ·åœ¨tickä¸Šçº¿é™ä¹‹é—´çš„æµåŠ¨ï¼Œtoken0å’Œtoken1æ”¶ç›Šï¼Œ åŠæµåŠ¨æ€§fee


é’ˆå¯¹ç”¨æˆ·swapçš„tokenInå’ŒtokenOutäº¤æ˜“æ± ä¸å­˜åœ¨æ—¶ï¼Œuniswapå‰ç«¯å°†ä¼šç”Ÿæˆç›¸åº”çš„è·¯å¾„ï¼Œå§”æ‰˜ç»™SwapRouterè¿›è¡Œswapæ“ä½œï¼›

å¤šè·¯å¾„çš„çš„æƒ…å†µç¼–ç ä¸ºï¼štoken0+fee01+token1+fee12+token2+fee23+token3+fee34+token4+..., è¿™ç§æ˜¯é’ˆå¯¹swapæ˜¯å¦‚æœæ²¡æœ‰å¯¹åº”çš„äº¤æ˜“æ± ï¼Œåˆ™ä»ä¸åŒçš„
äº¤æ˜“æ± è¿›è¡Œswapï¼Œ æ¯”å¦‚ä½¿ç”¨token0ï¼Œæƒ³swap token3ï¼Œæ•´ä¸ªswapçš„è·¯å¾„ä¸ºï¼ˆtoken0+fee01+token1ï¼Œtoken1+fee12+token2ï¼Œtoken2+fee23+token3ï¼‰ï¼Œä½¿ç”¨token0ä»
pool01ä¸­swapå‡ºtoken1ï¼Œä½¿ç”¨swapå‡ºçš„token1ä»pool12ä¸­swapå‡ºtoken2ï¼Œ ä½¿ç”¨swapå‡ºçš„token2ä»pool23ä¸­swapå‡ºtoken3ï¼›





# é™„
[uniswap pools](https://info.uniswap.org/#/pools)   
[Uniswap v2-core](https://github.com/Donaldhan/v2-core)     
[Uniswap v2-periphery](https://github.com/Donaldhan/v2-periphery)  
[Uniswap lib](https://github.com/Donaldhan/solidity-lib)    
[ä¸€æ–‡çœ‹æ‡‚Uniswapå’ŒSushiswap](https://zhuanlan.zhihu.com/p/226085593)   
[Uniswapæ·±åº¦ç§‘æ™®](https://zhuanlan.zhihu.com/p/380749685)    
[å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼šUniswap v2ç™½çš®ä¹¦ä¸­æ–‡ç‰ˆ](https://zhuanlan.zhihu.com/p/255190320)   
[Uniswap v3 è®¾è®¡è¯¦è§£](https://zhuanlan.zhihu.com/p/448382469)   
[Uniswap V3 åˆ°åº•æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿä¸€æ–‡å¸¦ä½ äº†è§£V3æ–°ç‰¹æ€§](https://zhuanlan.zhihu.com/p/359732262)  
[Uniswap v3 è¯¦è§£ï¼ˆä¸€ï¼‰ï¼šè®¾è®¡åŸç†](https://liaoph.com/uniswap-v3-1/) 
[uniswap - V3æºä»£ç å¯¼è¯»](https://learnblockchain.cn/article/2371) 
[Uniswap V3 ç™½çš®ä¹¦](https://uniswap.org/whitepaper-v3.pdf) 
[uniswap-v3 blog](https://uniswap.org/blog/uniswap-v3/) 
[jit-liquidity](https://uniswap.org/blog/jit-liquidity)  
[graphical-guide-for-understanding-uniswap](https://docs.ethhub.io/guides/graphical-guide-for-understanding-uniswap/)    
[ä»€ä¹ˆæ˜¯DeFiä¸­çš„é—ªç”µè´·ï¼Ÿ](https://academy.binance.com/zh/articles/what-are-flash-loans-in-defi)    

